# Steps to enable this build are:
#
# Generate the OAUTH-TOKEN atd at https://github.com/settings/applications
# Install travis: gem install travis
# Login to travis: travis login
# Encrypt the token: travis encrypt GH_TOKEN=[OAUTH-TOKEN] -r Intenet2/grouper --add env.global
#

# Grouper CI pipeline:
#
# 1) For every commit in master, shallow git clone
# 2) Build the whole project with Maven against the build matrix expansion. If any build fails, email committer and abort remaining steps
# 3) Run tests
#      - Start a local hsql db (todo or postgres via docker container?)
#      - use gsh to boostrap the initial database
#      - execute tests (capture output to a file?)
#      - mail the test results to the committer
#      - abort if any tests fail?
# 4) Abort if not a tagged build
# 5) Parse version number out of tag (GROUPER_RELEASE/2.5.x)
# 6) mvn versions:set the pom versions to this version
# 7) Rebuild project. If fails, email committer and abort remaining steps
# 8) Deploy to the Maven release-stage repo
# 9) Email all output to the committer
#
# TODO if you commit first, and tag later, does it trigger two separate steps

language: java
os: linux
# (DEPRECATED) sudo: false
branches:
  only:
  - master
  - travis
jdk:
  - openjdk8
stages:
  - compile
  - test
  - name: deploy_release
    if: tag =~ ^GROUPER_RELEASE/(\d+\.)+\d+

jobs:
  include:
    - stage: test
      script: docker run -d -e "POSTGRES_USER=grouper" -e "POSTGRES_PASSWORD=password" -e "POSTGRES_DB=grouper" -p 5432:5432  postgres
    -
      script: cp travis/mvn.settings.xml $HOME/.m2/settings.xml
    -
      script: mvn -f ./grouper-parent clean install
    -
      script: mvn -f ./grouper copy-dependencies
    -
      script: chmod u+x grouper/bin/gsh.sh && CLASSPATH=travis/confForTest grouper/bin/gsh.sh -registry -runscript -noprompt
    -
      script: chmod u+x travis/travis-test.sh && travis/travis-test.sh
    - stage: deploy_release
      #script: travis/deploy-to-sonatype.sh
      script: /bin/false


#before_script:
# - export JAVA_OPTS="-Xmx2048m"
#install:
#- mvn -f ./grouper-parent install -Dmaven.javadoc.skip=true -DskipTests=true -Dlicense.skip=true -B -V -q
#script:
#- mvn -f ./grouper-parent clean package -DskipTests=true -Dlicense.skip=true
#before_install:
#- chmod -R 777 ./travis/init-travis-build.sh
#- ./travis/init-travis-build.sh
##after_success:
##- chmod -R 777 travis/deploy-to-sonatype.sh
##- travis/deploy-to-sonatype.sh
##- mvn -f ./grouper-parent clean test cobertura:cobertura coveralls:cobertura -Dlicense.skip=true -DskipTests=true
##- chmod -R 777 travis/javadocs-ghpages.sh
##- travis/javadocs-ghpages.sh
env:
  global:
    - secure: "XmmxnbDo/FeIE2O5M6YMSKjULOgLPDDx79mcfRTf79Fvjiqw2yJBrheLwR2sYs4+6uw7Pe0FkKUXtyRrcK31JvWTuqvwTs08MgMt42VPx7xGX+96i8hN6QTF8D1B1YYRJnnXrtOrhqSbpm+jffw3PiK4f5fcKDntSaMbPUiVRDg="
    - secure: "MjJBfBqMpetCZ0PmcISetMxHAEcC83EawXmJuCW/F7RrCk8tBY+YglYSRHFqj/LDcwLHdDPuPOLHEv/RKPyqQvjYfJICwpQugMRrIUPuoXsg57xoSP36DBNG8qVCa5rS1qLaUb42fsvYXd9ufjKu8c0Eihq8pbz+yrXxKgvSpIU="
    - secure: "kJDUzde56X0epK70R9e2hN7Q6nfHyk0ixDOynPYJh01hREyLl/7Zm3V6dv5nfGhFbCoJDcqkTlUsl26ixrmmr4AUhh+fKkQVO8Pjj8z9fR6Y1lukJ2v2RVDRzN0sR5cCqKGd2yr9VW9s+4JinfcBQNj2dxwhCKddj+NPPM9o0CE="
deploy:
  provider: script
  script: chmod u+x travis/deploy-to-sonatype.sh && travis/deploy-to-sonatype.sh
  #(DEPRECATED) skip_cleanup: true
  on:
    #TODO set to true once deploy script works
    #tags: true
    tags: false
